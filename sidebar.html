<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" crossorigin="anonymous">
  <style>
    body { /* Tambahkan styling sesuai kebutuhan */ }
    .frame { padding: 20px; margin: 40px auto; }
    button { text-transform: uppercase; border-radius: 7px; }
    #loading { display: none; margin-top: 10px; text-align: center; }
    #preview { margin-top: 10px; }
    #preview img { max-width: 100%; max-height: 200px; margin: 5px; }
    .file-preview { margin-bottom: 10px; }
    .dynamic-file-upload { margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="frame">
      <form id="uploadForm">
        <div class="form-group">
          <label for="tanggal">Tanggal:</label>
          <input type="date" class="form-control" id="tanggal" required>
        </div>
        <div class="form-group">
          <label for="nama">Nama Donatur:</label>
          <input type="text" class="form-control" id="nama" placeholder="Masukkan nama" required>
        </div>
        <div class="form-group">
          <label for="akun">Akun:</label>
          <select class="form-control" id="akun" required>
            <option value="">Pilih Akun</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ponsel">Ponsel:</label>
          <input type="text" class="form-control" id="ponsel" placeholder="Masukkan nomor ponsel" required>
        </div>
        <div class="form-group">
          <label for="catatan">Catatan:</label>
          <input type="text" class="form-control" id="catatan" placeholder="Masukkan catatan" required>
        </div>
        <div class="form-group">
          <label for="jumlah">Jumlah:</label>
          <input type="number" class="form-control" id="jumlah" placeholder="Masukkan jumlah" required>
        </div>
        <div class="form-group">
          <label for="campaign">Campaign:</label>
          <select class="form-control" id="campaign" required>
            <option value="">Pilih Campaign</option>
          </select>
        </div>
        <div class="form-group">
          <label for="amil">Amil:</label>
          <select class="form-control" id="amil" required>
            <option value="">Pilih Amil</option>
          </select>
        </div>
        <div class="form-group">
          <label for="uploadFile">Upload File:</label>
          <input type="file" class="form-control-file" id="uploadFile" multiple onchange="encodeFiles()">
          <div id="preview"></div> <!-- Tempat untuk menampilkan preview -->
          <div class="form-group">
            <input type="checkbox" id="addMoreFiles" onchange="toggleAdditionalUpload()">
            <label for="addMoreFiles">Tambah Lagi File Tambahan</label>
          </div>
        </div>
        <div id="additionalUploadSection" style="display: none;">
          <label>Upload File Tambahan:</label>
          <input type="file" class="form-control-file" id="additionalUploadFile" multiple onchange="encodeAdditionalFiles()">
          <div id="additionalPreview"></div> <!-- Tempat untuk menampilkan preview tambahan -->
          <div class="form-group">
            <input type="checkbox" id="addMoreFilesDynamic" onchange="toggleDynamicUpload()">
            <label for="addMoreFilesDynamic">Tambah Lagi File Tambahan</label>
          </div>
          <div id="dynamicUploadSection"></div> <!-- Tempat untuk upload dinamis -->
        </div>
        <button type="button" class="btn btn-primary" onclick="handleSubmit()">Submit</button>
      </form>

      <div id="loading">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif" alt="Loading" width="50">
        <p>Loading...</p>
      </div>
    </div>
  </div>

  <script>
    var uploadFiles = [];
    var additionalUploadFiles = [];
    var dynamicUploadFiles = [];

    // Fungsi untuk menghilangkan duplikat dan mengisi dropdown dengan data
    function populateDropdowns() {
      var akunSelect = document.getElementById('akun');
      var uniqueAkunOptions = [...new Set(akunOptions)];
      uniqueAkunOptions.forEach(function(option) {
        var opt = document.createElement('option');
        opt.value = option;
        opt.innerHTML = option;
        akunSelect.appendChild(opt);
      });

      var campaignSelect = document.getElementById('campaign');
      var uniqueCampaignOptions = [...new Set(campaignOptions)];
      uniqueCampaignOptions.forEach(function(option) {
        var opt = document.createElement('option');
        opt.value = option;
        opt.innerHTML = option;
        campaignSelect.appendChild(opt);
      });

      var amilSelect = document.getElementById('amil');
      var uniqueAmilOptions = [...new Set(amilOptions)];
      uniqueAmilOptions.forEach(function(option) {
        var opt = document.createElement('option');
        opt.value = option;
        opt.innerHTML = option;
        amilSelect.appendChild(opt);
      });
    }

    function encodeFiles() {
      var files = document.getElementById("uploadFile").files;
      uploadFiles = []; // Reset array

      var previewDiv = document.getElementById("preview");
      previewDiv.innerHTML = ""; // Clear previous preview

      Array.from(files).forEach(file => {
        var reader = new FileReader();

        reader.onload = function(e) {
          if (file.type.startsWith("image/")) {
            var img = document.createElement("img");
            img.src = e.target.result;
            previewDiv.appendChild(img);
          } else {
            var fileName = document.createElement("p");
            fileName.textContent = "File yang dipilih: " + file.name;
            previewDiv.appendChild(fileName);
          }

          var base64String = e.target.result.split(",")[1];
          uploadFiles.push({
            name: file.name,
            type: file.type,
            data: base64String
          });
        };
        reader.readAsDataURL(file);
      });
    }

    function encodeAdditionalFiles() {
      var files = document.getElementById("additionalUploadFile").files;
      additionalUploadFiles = []; // Reset array

      var additionalPreviewDiv = document.getElementById("additionalPreview");
      additionalPreviewDiv.innerHTML = ""; // Clear previous preview

      Array.from(files).forEach(file => {
        var reader = new FileReader();

        reader.onload = function(e) {
          if (file.type.startsWith("image/")) {
            var img = document.createElement("img");
            img.src = e.target.result;
            additionalPreviewDiv.appendChild(img);
          } else {
            var fileName = document.createElement("p");
            fileName.textContent = "File tambahan yang dipilih: " + file.name;
            additionalPreviewDiv.appendChild(fileName);
          }

          var base64String = e.target.result.split(",")[1];
          additionalUploadFiles.push({
            name: file.name,
            type: file.type,
            data: base64String
          });
        };
        reader.readAsDataURL(file);
      });
    }

    function toggleAdditionalUpload() {
      var additionalSection = document.getElementById("additionalUploadSection");
      additionalSection.style.display = document.getElementById("addMoreFiles").checked ? "block" : "none";
    }

    function toggleDynamicUpload() {
      var dynamicSection = document.getElementById("dynamicUploadSection");
      if (document.getElementById("addMoreFilesDynamic").checked) {
        var newUploadDiv = document.createElement("div");
        newUploadDiv.className = "dynamic-file-upload";
        newUploadDiv.innerHTML = `
          <input type="file" class="form-control-file" onchange="encodeDynamicFiles(this)">
          <div class="file-preview"></div> <!-- Tempat untuk menampilkan preview -->
          <button type="button" class="btn btn-danger" onclick="removeDynamicUpload(this)">Hapus</button>
          <div class="form-group">
            <input type="checkbox" onchange="toggleDynamicUpload()"> 
            <label>Tambah Lagi File Tambahan</label>
          </div>
        `;
        dynamicSection.appendChild(newUploadDiv);
      }
    }

    function encodeDynamicFiles(input) {
      var files = input.files;
      var dynamicPreviewDiv = input.nextElementSibling; // Preview div
      dynamicPreviewDiv.innerHTML = ""; // Clear previous preview
      dynamicUploadFiles = []; // Reset array for dynamic uploads

      Array.from(files).forEach(file => {
        var reader = new FileReader();

        reader.onload = function(e) {
          if (file.type.startsWith("image/")) {
            var img = document.createElement("img");
            img.src = e.target.result;
            dynamicPreviewDiv.appendChild(img);
          } else {
            var fileName = document.createElement("p");
            fileName.textContent = "File dinamis yang dipilih: " + file.name;
            dynamicPreviewDiv.appendChild(fileName);
          }

          var base64String = e.target.result.split(",")[1];
          dynamicUploadFiles.push({
            name: file.name,
            type: file.type,
            data: base64String
          });
        };
        reader.readAsDataURL(file);
      });
    }


    function removeDynamicUpload(button) {
      var dynamicUploadDiv = button.parentElement; // Ambil div yang berisi tombol hapus
      dynamicUploadDiv.remove(); // Hapus div
    }

    function handleSubmit() {
    var tanggal = document.getElementById("tanggal").value;
    var nama = document.getElementById("nama").value;
    var akun = document.getElementById("akun").value;
    var ponsel = document.getElementById("ponsel").value;
    var catatan = document.getElementById("catatan").value;
    var jumlah = document.getElementById("jumlah").value;
    var campaign = document.getElementById("campaign").value;
    var amil = document.getElementById("amil").value;

    if (!tanggal || !nama || !akun || !ponsel || !catatan || !jumlah || !campaign || !amil || uploadFiles.length === 0) {
      Swal.fire({
        title: 'Error!',
        text: 'Please fill out all fields and upload at least one file!',
        icon: 'warning'
      });
      return;
    }

    document.getElementById("loading").style.display = "block";

    // Gabungkan semua file yang diupload
    var allUploadedFiles = [...uploadFiles, ...additionalUploadFiles, ...dynamicUploadFiles];

    google.script.run
      .withSuccessHandler(function(urls) {
        document.getElementById("loading").style.display = "none";
        Swal.fire({
          title: 'Success!',
          text: 'Data has been uploaded!',
          icon: 'success',
          timer: 2000,
          showConfirmButton: false
        });
        
        // Tampilkan URL file di preview
        var previewDiv = document.getElementById("preview");
        previewDiv.innerHTML = ""; // Clear previous preview

        // Menampilkan setiap URL di baris baru
        urls.forEach(function(url) {
          var link = document.createElement("a");
          link.href = url;
          link.textContent = url;
          link.target = "_blank"; // Membuka link di tab baru
          var lineBreak = document.createElement("br");
          previewDiv.appendChild(link);
          previewDiv.appendChild(lineBreak);
        });

        document.getElementById("uploadForm").reset();
        document.getElementById("dynamicUploadSection").innerHTML = ""; // Clear dynamic uploads after submission
      })
      .saveData({
        tanggal: tanggal,
        nama: nama,
        akun: akun,
        ponsel: ponsel,
        catatan: catatan,
        jumlah: jumlah,
        uploadFiles: allUploadedFiles, // Kirim gabungan file yang diupload
        campaign: campaign,
        amil: amil
      });
  }

  function goBack() {
            // Kembali ke menu pemilihan
            google.script.run.showChooseUploadMenu();
        }

    window.onload = populateDropdowns; // Panggil fungsi untuk mengisi dropdown saat halaman dimuat
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
</body>
</html>
